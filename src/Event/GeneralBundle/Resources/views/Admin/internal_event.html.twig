{% extends '::base.html.twig' %}
{% block body %}

<div class='admin_container'>

{% include 'EventGeneralBundle:Admin:admin_menu.html.twig' %}

<h1 style='color: orange'>
    {{ event.id }}. {{ event.name }}
    <br />
    ({{ event.getHumanDate }})
</h1>

<div style='width: 700px; margin-right: 20px; float: left;'>

    <form id="general_form" action="{{ path('internal_event', { 'id': id }) }}" method="post" {{ form_enctype(form) }} novalidate>

    <table class='settings'>
        <thead>
            <td colspan="2">
                Settings
            </td>
        </thead>
        <tbody>
            <tr>
                <td><b>Name</b></td>
                <td>{{ form_widget(form.name) }}</td>
            </tr>
            <tr>
                <td {% if not event.urlName %}class='notice-warning'{% endif %}><b>URL Name</b></td>
                <td>{{ form_widget(form.urlName) }}</td>
            </tr>
            <tr>
                <td style='width: 20%'><b>Status</b></td>
                <td style='width: 60%'
                    {% if event.getStatus() == 0 %}
                        class='notice-yellow'
                    {% elseif event.getStatus() == 1 %}
                        class='notice-green'
                    {% elseif event.getStatus() == 2 %}
                        class='warning'
                    {% elseif event.getStatus() == 3 %}
                        class='notice-black'
                    {% endif %} >
                    {{ event.getStatusName() }}
                </td>
            </tr>
            <tr>
                <td style='width: 20%'><b>Place</b></td>
                <td style='width: 60%'><a href="{{ path('place', { 'id': event.place }) }}">{{ places[ event.place ].name }}</a></td>
            </tr>
            <tr>
                <td><b>Date</b></td>
                <td>{{ form_widget(form.date) }}</td>
            </tr>
            <tr>
                <td><b>Start</b></td>
                <td>{{ form_widget(form.start) }}</td>
            </tr>
            <tr>
                <td><b>Duration</b></td>
                <td>{{ form_widget(form.duration) }}</td>
            </tr>
            <tr>
                <td {% if not event.catalogRate or event.catalogRate == 0 %}class='notice-warning'{% endif %}><b>Catalog Rate</b> (0-5)</td>
                <td>{{ form_widget(form.catalogRate) }}</td>
            </tr>
            <tr>
                <td><b>Style</b></td>
                <td>{{ form_widget(form.style) }}</td>
            </tr>
            <tr>
                <td><b>Medium Theme</b></td>
                <td>{{ form_widget(form.theme) }}</td>
            </tr>
            <tr>
                <td><b>Big Theme</b></td>
                <td>{{ form_widget(form.bigTheme) }}</td>
            </tr>
            <tr>
                <td {% if not event.video  %}class='notice-warning'{% endif %}><b>Videos</b> (comma sep: xxx,yyy)</td>
                <td>{{ form_widget(form.video) }}</td>
            </tr>
            <tr>
                <td {% if event.getTagsList()|length == 0  %}class='notice-warning'{% endif %}><b>Tags</b></td>
                <td class='small_textarea'>
                    <ul id="tags" class='tagit'>
                        {% for t in event.getTagsList() %}
                            <li>{{ tags[t].name }}</li>
                        {% endfor %}
                    </ul>

                    {% if event.getArtistsList()|length > 0 %}
                        <div>
                            <input type="button" value="suggest" onclick="suggestTags()" />
                        </div>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td colspan="2" {% if not event.description or event.description|length < 100 %}class='notice-warning'{% endif %}><b>Description</b></td>
            </tr>
            <tr>
                <td colspan="2">{{ form_widget(form.description) }}</td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: center">
                    {{ form_rest(form) }}
                    <input type="button" onclick="preSubmit()" value="Save" />
                </td>
            </tr>
        </tbody>
    </table>

    </form>

    <table class='settings'>
        <thead>
            <td colspan="2" style='background-color: #ffc866'>Actions</td>
        </thead>
        <tbody>
            {% if event.status != 0 %}
                <tr>
                    <td><a href="{{ path('wait_internal_event', { 'id': id }) }}">To Wait</a></td>
                </tr>
            {% endif %}

            {% if event.status != 1 %}
                <tr>
                    <td><a href="{{ path('work_internal_event', { 'id': id }) }}">To Work</a></td>
                </tr>
            {% endif %}

            {% if event.status != 2 %}
                <tr>
                    <td><a href="{{ path('cancel_internal_event', { 'id': id }) }}">Cancel event</a></td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <table class='settings'>
        <thead>
            <td colspan="2">Images</td>
        </thead>
        <tbody>
            <form action="{{ path('crop_image') }}" method="post" enctype='multipart/form-data'>
                <input type="hidden" id="small_x" name="x" />
                <input type="hidden" id="small_y" name="y" />
                <input type="hidden" id="small_w" name="w" />
                <input type="hidden" id="small_h" name="h" />

                <input type="hidden" name="t_w" value="231" />
                <input type="hidden" name="t_h" value="260" />

                <input type="hidden" id="small_image_width" name="iw" />
                <input type="hidden" id="small_image_height" name="ih" />

                <input type="hidden" value="{{ event.id }}" name="id" />
                <input type="hidden" value="catalog" name="image_type" />
                <input type="hidden" value="small" name="type" />

                <tr>
                    <td {% if not event.getAdditional('catalog-image-small') %}class='notice-warning'{% endif %}><b>Image Catalog Small</b> (231 x 260)</td>
                    <td>
                        <input type="file" name="image" id="image_small">
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <img src="" id="small_target" />
                        <img src="{{ asset('uploads/catalog/small_' ~ event.id ~ '.jpg') }}" id="small_preview" style="border: 1px solid black; width: 231px; height: 260px"/>
                        <br />
                        <input type="submit" value="CROP" />
                    </td>
                </tr>
            </form>

            <form action="{{ path('crop_image') }}" method="post" enctype='multipart/form-data'>
                <input type="hidden" id="medium_x" name="x" />
                <input type="hidden" id="medium_y" name="y" />
                <input type="hidden" id="medium_w" name="w" />
                <input type="hidden" id="medium_h" name="h" />

                <input type="hidden" name="t_w" value="474" />
                <input type="hidden" name="t_h" value="260" />

                <input type="hidden" id="medium_image_width" name="iw" />
                <input type="hidden" id="medium_image_height" name="ih" />

                <input type="hidden" value="{{ event.id }}" name="id" />
                <input type="hidden" value="catalog" name="image_type" />
                <input type="hidden" value="medium" name="type" />

                <tr>
                    <td {% if not event.getAdditional('catalog-image-medium') %}class='notice-warning'{% endif %}><b>Image Catalog Medium</b> (474 x 260)</td>
                    <td>
                        <input type="file" name="image" id="image_medium">
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <img src="" id="medium_target" />
                        <img src="{{ asset('uploads/catalog/medium_' ~ event.id ~ '.jpg') }}" id="medium_preview" style="border: 1px solid black; width: 474px; height: 260px"/>
                        <br />
                        <input type="submit" value="CROP" />
                    </td>
                </tr>
            </form>

            <form action="{{ path('crop_image') }}" method="post" enctype='multipart/form-data'>
                <input type="hidden" id="medium2_x" name="x" />
                <input type="hidden" id="medium2_y" name="y" />
                <input type="hidden" id="medium2_w" name="w" />
                <input type="hidden" id="medium2_h" name="h" />

                <input type="hidden" id="medium2_image_width" name="iw" />
                <input type="hidden" id="medium2_image_height" name="ih" />

                <input type="hidden" name="t_w" value="636" />
                <input type="hidden" name="t_h" value="450" />

                <input type="hidden" value="{{ event.id }}" name="id" />
                <input type="hidden" value="event" name="image_type" />
                <input type="hidden" value="medium" name="type" />

                <tr>
                    <td {% if not event.getAdditional('event-image-medium') %}class='notice-warning'{% endif %}><b>Image Event Medium</b> (636 x 450)</td>
                    <td>
                        <input type="file" name="image" id="image_medium2">
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <img src="" id="medium2_target" />
                        <img src="{{ asset('uploads/event/medium_' ~ event.id ~ '.jpg') }}" id="medium2_preview" style="border: 1px solid black; width: 636px; height: 450px"/>
                        <br />
                        <input type="submit" value="CROP" />
                    </td>
                </tr>
            </form>


            <form action="{{ path('crop_image') }}" method="post" enctype='multipart/form-data'>
                <input type="hidden" id="big_x" name="x" />
                <input type="hidden" id="big_y" name="y" />
                <input type="hidden" id="big_w" name="w" />
                <input type="hidden" id="big_h" name="h" />

                <input type="hidden" id="big_image_width" name="iw" />
                <input type="hidden" id="big_image_height" name="ih" />

                <input type="hidden" name="t_w" value="636" />
                <input type="hidden" name="t_h" value="600" />

                <input type="hidden" value="{{ event.id }}" name="id" />
                <input type="hidden" value="event" name="image_type" />
                <input type="hidden" value="big" name="type" />

                <tr>
                    <td {% if not event.getAdditional('event-image-big') %}class='notice-warning'{% endif %}><b>Image Event Big</b> (636 x 600)</td>
                    <td>
                        <input type="file" name="image" id="image_big">
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <img src="" id="big_target" />
                        <img src="{{ asset('uploads/event/big_' ~ event.id ~ '.jpg') }}" id="big_preview" style="border: 1px solid black; width: 636px; height: 600px"/>
                        <br />
                        <input type="submit" value="CROP" />
                    </td>
                </tr>
            </form>
        </tbody>
    </table>
</div>

<div style='width: 450px; float: left;'>
    <table class='settings'>
        <thead>
            <tr>
                <td colspan="3">Artists</td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="3">
                    <form action="{{ path('add_artist_to_internal', { 'id': id }) }}" method="post" novalidate>
                        <input type="text" style='width: 200px;' id="artist" name="artist">
                        <input type="submit" value="add">
                    </form>
                </td>
            </tr>
            {% for a in event.getArtistsList() %}
                <tr>
                    <td> 
                        <b><a href="{{ path('artist', { 'id': a }) }}">{{ artists[ a ].name }}</a></b> 
                    </td>
                    {% if artists[ a ].getTags %}
                        <td>
                            {% for t in artists[ a ].getTagsList %}
                                {{ tags[ t ].name }}{% if not loop.last %},{% endif %}
                            {% endfor %}
                        </td>
                    {% else %}
                        <td class="notice-pink">
                            -
                        </td>
                    {% endif %}
                    <td>
                        [ <a href="{{ path('drop_artist_from_internal', { 'id': event.id }) }}?artist={{ a }}">drop</a> ]
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if matched|length > 0 %}
        <table class='settings' style='font-size: 12px;'>
            <thead>
                <tr>
                    <td colspan="5">Matches</td>
                </tr>
                <tr>
                    <td style='width: 5%'>status</td>
                    <td style='width: 40%'>name</td>
                    <td style='width: 10%'>provider</td>
                    <td style='width: 20%'>provider status</td>
                    <td style='width: 20%'>actions</td>
                </tr>
            </thead>
            <tbody>
                {% for m in matched %}
                    <tr>
                        {% if matched_events[m.getProviderId].status == 1 and m.status == 1  %}
                            <td class='notice-green'>on</td>
                        {% else %}
                            <td class='notice-warning'>off</td>
                        {% endif %}
                        <td>
                            <a style='color: {% if m.status == 0 %}red{% elseif m.status == 1 %}green{% endif %}' 
                            href="{{ path('provider_event', { 'id': m.getProviderId }) }}">{{ matched_events[m.getProviderId].name }}</a>
                        </td>
                        <td>
                            <a href="{{ matched_events[m.getProviderId].link }}" target="_blank">
                                {{ providers[ matched_events[m.getProviderId].getProvider ].getName() }}
                            </a>
                        </td>
                        <td 
                            {% if matched_events[m.getProviderId].status == 0 %}
                                class='notice-pink'
                            {% elseif matched_events[m.getProviderId].status == 1 %}
                                class='notice-green'
                            {% elseif matched_events[m.getProviderId].status == 2 %}
                                class='notice-warning'
                            {% elseif matched_events[m.getProviderId].status == 3 %}
                                class='notice-yellow'
                            {% elseif matched_events[m.getProviderId].status == 4 %}
                                class='notice-orange'
                            {% elseif matched_events[m.getProviderId].status == 5 %}
                                class='notice-black'
                            {% endif %} >
                            {{ matched_events[m.getProviderId].getStatusName() }} 
                        </td>
                        <td>
                            [ <a href="{{ path('unmatch_provider_event', { 'id': m.getProviderId }) }}?return_to_internal={{ event.getId() }}">unmatch</a> ]
                            <br />
                            {% if m.status == 0 %}
                                [ <a href="{{ path('change_match_status', { 'id': m.id, 'status': 1 }) }}">approve</a> ]
                            {% elseif m.status == 1 %}
                                [ <a href="{{ path('change_match_status', { 'id': m.id, 'status': 0 }) }}">hide</a> ]
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <table class='settings'>
        <thead>
            <tr>
                <td colspan="6">Tickets</td>
            </tr>
            <tr>
                <td style='width: 3%'>id</td>
                <td style='width: 5%'>provider</td>
                <td style='width: 40%'>sector</td>
                <td style='width: 5%'>min</td>
                <td style='width: 5%'>max</td>
                <td style='width: 20%'>action</td>
            </tr>
        </thead>
        <tbody style='font-size: 12px;'>
            {% for p_id, ts in tickets %}
                {% for t in ts %}
                    <tr> 
                        <td {% if t.status == 0 %}class="notice-warning"{% endif %}>
                            {{ t.id }}
                        </td>
                        <td>
                            {{ providers[ matched_events[ p_id ].provider ].name }} 
                        </td>
                        <td>{{ t.sector }}</td>
                        <td>{{ t.priceMin}}</td>
                        <td>{{ t.priceMax }}</td>
                        <td>
                            {% if t.status == 1 %}
                                [ <a href="{{ path('change_ticket_status', { 'id': t.id, 'status': 0 }) }}?return_to_internal={{ event.id }}">hide</a> ]
                            {% else %}
                                [ <a href="{{ path('change_ticket_status', { 'id': t.id, 'status': 1 }) }}?return_to_internal={{ event.id }}">show</a> ]
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
<div>

<div>

<script>
$(document).ready(function () {
    $("#artist").tokenInput("{{ path('search_artists') }}", {
        tokenLimit: 1
    });

    // Tags
    $('#tags').tagit({
        singleField: 1,
        allowSpaces: 1,
        fieldName: 'tags',
    });
});

function preSubmit() {
    $("#event_generalbundle_internalevent_tags").val( $("[name='tags']").val() );
    $("#general_form").submit();
}

function suggestTags() {
    {% for a in event.getArtistsList() %}
        {% for t in artists[ a ].getTagsList %}
            $("#tags").tagit("createTag", "{{ tags[ t ].name }}");
        {% endfor %}
    {% endfor %}
}

// Crop
var image_sizes = { 'small': 0.888, 'medium': 1.784, 'big': 1.06, 'medium2': 1.413 };
var selected_size = 'small';

$.each(image_sizes, function(size, ratio) {
    $("#image_" + size).change(function() {
        $("#" + size + "_preview").hide();
        readURL(this, size, ratio);
    });
});

function readURL(input, size, ratio) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();

        reader.onload = function (e) {
            $('#' + size + '_target').attr('src', e.target.result);

            $('#' + size + '_image_width').val( $('#' + size + '_target').width() );
            $('#' + size + '_image_height').val( $('#' + size + '_target').height() );

            selected_size = size;

            jQuery(function($) {
                    $('#' + size + '_target').Jcrop({
                        onSelect: updateCoords,
                        aspectRatio: ratio 
                    });
            });
        }

        reader.readAsDataURL(input.files[0]);
    }
}

function updateCoords(c) {
    $('#' + selected_size + '_x').val(c.x);
    $('#' + selected_size + '_y').val(c.y);
    $('#' + selected_size + '_w').val(c.w);
    $('#' + selected_size + '_h').val(c.h);
};

tinymce.init({
    selector: "textarea#event_generalbundle_internalevent_description"
});

</script>

{% endblock %}
